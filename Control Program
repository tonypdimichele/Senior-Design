//
    
    #include <Stepper.h>
    #include <AltSoftSerial.h>
    #include <avr/sleep.h> //this AVR library contains the methods that controls the sleep modes
    
    #define interruptPin 2 //Pin we are going to use to wake up the Arduino

      AltSoftSerial BTserial; 
      Stepper stepper1(200, 4, 5, 6, 7);
      Stepper stepper2(200, 10, 11, 12, 13);
      int step_parameter = 0;
      int step_parameter_new = 0;
      int actuation = 0;
      int light_data_int;
      int light_set_point = 250;
      int steps = 10 ;
      String light_data = " ";
      bool sleep_parameter = 0;
      String inByte;
      bool program_state = 0;
      int flap = 50;   
    void setup()
    {
      Serial.begin(9600);
      Serial.println("Stepper test!");
      stepper1.setSpeed(30); // set the speed of the motor (RPM)
      stepper2.setSpeed(10);
      stepper2.step(flap);
      BTserial.begin(9600);  
      Serial.println("BTserial started at 9600");
      delay(2000);

      // Interupt Pin Set-up
      pinMode(interruptPin,INPUT_PULLUP);//Set pin d2 to input using the buildin pullup resistor
    }
     
    void loop()
    {
      if(program_state == 1){

          // Attach Switch Interupt
            attachInterrupt(digitalPinToInterrupt(interruptPin), changeState, RISING);

          //Recieve Data From App
            inByte = (Serial.readString());
            Serial.println("inByte "); Serial.print(inByte);
            light_set_point = (inByte.toInt());
            Serial.println("light_set_point "); Serial.print(light_set_point);
            delay(50);

          // This will read the serial data coming from the light sensor and convert it into an integer
            light_data = BTserial.readString();
            Serial.println(light_data);  //debugging, comment out when working
            light_data_int = light_data.toInt();
            Serial.println(light_data_int);  //debugging, comment out when working
       
          // Clockwise Motor Actuation 
            if((light_data_int < light_set_point) && (light_set_point-light_data_int > 10)){
              stepper1.step(steps);
              Serial.println("Actuating up!!");
            }
       
          // Counterclockwise Actuation
            else if(light_data_int > light_set_point  && (light_set_point-light_data_int < -10)){
              Serial.println("Actuating down!!"); //debugging, comment out when working
              stepper1.step(-steps);
            }

          // DO NOT ACUTATE MOTOR
            else if(light_set_point-light_data_int >= 10 || light_set_point-light_data_int <= -10){
              Serial.println("Not Actuating!!");  // debugging, comment out when working
            }
     
          // reset the serial port     
            while(Serial.read() >= 0);
            Serial.read();

          // reset Bluetooth serial
            while(BTserial.read() >= 0);
            BTserial.read();
      }

      if(program_state == 0){
          stepper2.step(-flap);
          sleep_enable();//Enabling sleep mode
          attachInterrupt(digitalPinToInterrupt(interruptPin), changeState, RISING);
          set_sleep_mode(SLEEP_MODE_PWR_DOWN);
          sleep_cpu(); 
          Serial.println("just woke up!");
          stepper2.step(flap);
      }    
    }

    void changeState(){

      Serial.println("Interrrupt Fired");    

//      if(program_state == 0){
//         //Open flap
//         Serial.println("Opening Flap");        
//      }
//
//      else {
//         //Close Flap
//         Serial.println("CLosing Flap");  
//      }

      program_state = !program_state;
      Serial.println(program_state);
      sleep_disable();
      detachInterrupt(0);
    }
